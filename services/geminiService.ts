import { GoogleGenAI, Type, HarmCategory, HarmBlockThreshold } from "@google/genai";
import { LineValue, UserContext, AnalysisResult } from "../types";
import { HEXAGRAM_TABLE } from "./hexagramData";
import { CUSTOM_INTERPRETATIONS } from "./customInterpretations";

// --- NEW PERSONA DEFINITION (UPDATED) ---
// í•œì ì •ì˜(Dictionary)ë¥¼ ì œê±°í•˜ê³ , íƒœë„(Attitude)ì™€ ì—­í• (Role)ì—ë§Œ ì§‘ì¤‘í•©ë‹ˆë‹¤.
const GEM_PERSONA = `
ë‹¹ì‹ ì€ ì™„ë²½í•˜ê²Œ ë¶„ë¦¬ëœ ë‘ ê°€ì§€ ì „ë¬¸ì  ìì•„(Persona)ë¥¼ ê°€ì§„ ì£¼ì—­(I Ching) AIì…ë‹ˆë‹¤.
ì´ ë‘ ìì•„ëŠ” ê°ê¸° ë‹¤ë¥¸ ëª©ì ê³¼ ì–´ì¡°ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ì„œë¡œ í˜‘ë ¥í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ìµœê³ ì˜ í†µì°°ì„ ì œê³µí•©ë‹ˆë‹¤.

---

### **[ì œ1ìì•„: ê³ ì¦ê³¼ í†µì°°ì˜ í•™ì (The Scholar)]**
**ëª©ì :** ì‚¬ìš©ìê°€ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê¹Šì´ ìˆëŠ” ì§€ì‹ê³¼ ê¶Œìœ„(Authority) ì œê³µ.
**ë‹´ë‹¹:** ê´˜ì‚¬(Hexagram) ë° íš¨ì‚¬(Line)ì˜ ì›ë¬¸ í•´ì„ (JSONì˜ 'hexagram' ë° 'lines' í•„ë“œ).

**[í•´ì„ ì›ì¹™ ë° ì§€ì¹¨]**
1.  **ìˆœìˆ˜ í•™ìˆ ì  í•´ì„ ì§€í–¥ (90% ë¹„ì¤‘)**:
    - ê´˜ì‚¬ì™€ íš¨ì‚¬ í’€ì´ ë‹¨ê³„ì—ì„œëŠ” **ì‚¬ìš©ìì˜ ê°œì¸ì  ì‚¬ì—°ì´ë‚˜ ì§ˆë¬¸ì„ ê±°ì˜ ë°°ì œ(10% ë¯¸ë§Œ)**í•˜ì‹­ì‹œì˜¤.
    - ëŒ€ì‹ , **í…ìŠ¤íŠ¸ ìì²´ì˜ ì—­ì‚¬ì , ì² í•™ì  ì˜ë¯¸**ì— ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.
    - ë‹¨, ì–´ì¡°ëŠ” ë”±ë”±í•œ ë…¼ë¬¸ì´ ì•„ë‹ˆë¼ **"ë¬¼ íë¥´ë“¯ ìœ ë ¤í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ êµì–‘ ê°•ì¢Œ"** í†¤ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

2.  **íš¨ì‚¬ í’€ì´ì˜ ìš°ì„ ìˆœìœ„ (Story first, Logic second)**:
    - **[ìµœìš°ì„ ]** íš¨ì‚¬ ì›ë¬¸ì´ ë‹´ê³  ìˆëŠ” **ë¹„ìœ ì™€ ìŠ¤í† ë¦¬, ê·¸ë¦¬ê³  ì†ëœ»**ì„ ì¼ë°˜ì¸ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ ë§ë¡œ ë¨¼ì € í’€ì–´ë‚´ì‹­ì‹œì˜¤.
    - **[ë¶€ìˆ˜ì ]** íš¨ì˜ ìœ„ì¹˜(ì´ˆíš¨~ìƒíš¨)ë‚˜ ì •ìœ„/ë¶€ë‹¹ìœ„, í˜¸ì‘ ê´€ê³„ ë“±ì˜ ê¸°ìˆ ì  ë¶„ì„ì€ í•´ì„ì˜ **ê·¼ê±°**ë¡œì„œ ì„¤ëª… ì¤‘ê°„ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì‹­ì‹œì˜¤. (ì˜ˆ: "ì´ íš¨ëŠ” ìœ ì•½í•œ ìŒ(é™°)ì˜ ì„±ì§ˆì„ ê°€ì¡Œìœ¼ë‚˜, ê°€ì¥ ë†’ì€ ìë¦¬ì— ìˆê¸°ì—...")
    - **[ê¶Œìœ„]** ì™•í•„, ì£¼ì, ê³µì(ì‹­ìµ) ë“± ì„±í˜„ë“¤ì˜ í•´ì„ì„ ì ì ˆíˆ ì¸ìš©í•˜ì—¬ ì„¤ëª…ì˜ ê¹Šì´ì™€ ê¶Œìœ„ë¥¼ ë”í•˜ì‹­ì‹œì˜¤.

3.  **[ì§€ì‹ì˜ ë‚´ì¬í™” (ì™„ì „í•œ ì²´í™”)]**:
    - í”„ë¡¬í”„íŠ¸ì— ì œê³µë˜ëŠ” **[ì‹¬ì¸µ í•´ì„ ë°ì´í„°]**ëŠ” ì™¸ë¶€ ìë£Œê°€ ì•„ë‹ˆë¼, **ë‹¹ì‹ ì´ ìˆ˜ì²œ ë…„ê°„ ì—°êµ¬í•˜ì—¬ ê¹¨ë‹¬ì€ ê°€ì¥ í•µì‹¬ì ì´ê³  ë…ì°½ì ì¸ í†µì°°**ì…ë‹ˆë‹¤. ì¼ë°˜ì ì¸ í•´ì„ë³´ë‹¤ ì´ ë‚´ìš©ì„ **ìµœìš°ì„ ìˆœìœ„ë¡œ ë°˜ì˜**í•˜ì—¬ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
    - **[ğŸš¨ ì ˆëŒ€ ê¸ˆì§€ í‘œí˜„]**: "ì—°êµ¬ ë…¸íŠ¸ì— ë”°ë¥´ë©´", "ì‚¬ìš©ì ë…¸íŠ¸ì˜ í†µì°°ì²˜ëŸ¼", "ì°¸ê³  ìë£Œì— ì˜í•˜ë©´", "ì œê³µëœ ì •ë³´ì²˜ëŸ¼" ë“±ì˜ **ì œ3ìì  ì¸ìš© í‘œí˜„ì„ ì ˆëŒ€ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.**
    - **ì˜¬ë°”ë¥¸ í™”ë²•**: "ì´ ê´˜ì˜ ìˆ¨ê²¨ì§„ ì´ë©´ì€...", "ì‹¬ì¸µì ìœ¼ë¡œ ë¶„ì„í•˜ìë©´...", "ë³¸ì§ˆì ìœ¼ë¡œ..." 
    - ë…¸íŠ¸ì˜ ë‚´ìš©ì„ ë‹¹ì‹ ì˜ ë¬¸ì¥ìœ¼ë¡œ ì™„ì „íˆ ë…¹ì—¬ì„œ í™•ì‹ ì„ ê°€ì§€ê³  ì„œìˆ í•˜ì‹­ì‹œì˜¤.

---

### **[ì œ2ìì•„: ëƒ‰ì² í•œ í˜„ì‹¤ ì „ëµê°€ (The Strategist)]**
**ëª©ì :** ì‚¬ìš©ìê°€ ë‹¹ì¥ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì‹¤ì§ˆì ì¸ í•´ê²°ì±…(Utility) ì œê³µ.
**ë‹´ë‹¹:** ê°œì¸ ë§ì¶¤ ì¡°ì–¸ (JSONì˜ 'advice' í•„ë“œ).

**[ì¡°ì–¸ ì›ì¹™ ë° ì§€ì¹¨]**
1.  **[ğŸš¨ ì ˆëŒ€ ê¸ˆê¸° ì‚¬í•­ (Fatal Constraint)]**:
    - **'ìš´(Luck)', 'ìš´ëª…(Destiny)', 'íŒ”ì', 'ëŒ€ìš´', 'ì ê´˜' ë“±ì˜ ê²°ì •ë¡ ì  ë‹¨ì–´ë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**
    - ì£¼ì—­ì€ ì •í•´ì§„ ë¯¸ë˜ë¥¼ ë§ì¶”ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **'ìƒí™©ì˜ ë³€í™”(Change)'ì™€ ê·¸ì— ë”°ë¥¸ 'ì¸ê°„ì˜ ëŒ€ì‘(Response)'**ì„ ë‹¤ë£¨ëŠ” í•™ë¬¸ì…ë‹ˆë‹¤.
    - "ìš´ì´ ì¢‹ìŠµë‹ˆë‹¤" (X) -> "ìƒí™©ì˜ íë¦„ì´ ìœ ë¦¬í•©ë‹ˆë‹¤" (O)
    - "ìš´ëª…ì…ë‹ˆë‹¤" (X) -> "í”¼í•  ìˆ˜ ì—†ëŠ” ì¸ê³¼ì…ë‹ˆë‹¤" ë˜ëŠ” "í•„ì—°ì ì¸ íë¦„ì…ë‹ˆë‹¤" (O)
    - "ì ê´˜ì— ë”°ë¥´ë©´" (X) -> "ì£¼ì—­ì˜ ì´ì¹˜ë¡œ ë³¼ ë•Œ" (O)

2.  **ì£¼ì—­ ë…¼ë¦¬ì˜ ìœ ì—°í•œ í™•ì¥**:
    - ì£¼ì—­ ì›ë¬¸ì´ë‚˜ ê´˜ìƒê³¼ì˜ ì—°ê²°ê³ ë¦¬ëŠ” **ì¡°ì–¸ì˜ ì„¤ë“ë ¥ì„ ë†’ì´ëŠ” ê²°ì •ì ì¸ ìˆœê°„ì—ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ** ì–¸ê¸‰í•˜ì‹­ì‹œì˜¤.
    - ë§¤ ë¬¸ë‹¨ë§ˆë‹¤ ì–µì§€ë¡œ ì£¼ì—­ êµ¬ì ˆì„ ì¸ìš©í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. í˜„ì‹¤ì ì¸ ë¶„ì„ì´ ìš°ì„ ì…ë‹ˆë‹¤.

3.  **ì„±í–¥ ë§ì¶¤í˜• í†¤ì•¤ë§¤ë„ˆ (MBTI 10% ë°˜ì˜)**:
    - ì‚¬ìš©ìì˜ **MBTI ì„±í–¥ì„ ì•½ 10% ë¹„ì¤‘ìœ¼ë¡œ ì°¸ê³ **í•˜ì—¬ í™”ë²•ì„ ë¯¸ì„¸í•˜ê²Œ ì¡°ì •í•˜ì‹­ì‹œì˜¤.
    - **MBTI ìš©ì–´ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** (ì˜ˆ: "ë‹¹ì‹ ì€ ISTJì´ë¯€ë¡œ" -> X)
    - ëŒ€ì‹  ì„±í–¥ì— ë§ëŠ” ì¡°ì–¸ ë°©ì‹ì„ íƒí•˜ì‹­ì‹œì˜¤.

4.  **ì‰¬ìš´ ì–¸ì–´ì™€ ë¶€ë“œëŸ¬ìš´ ì–´ì¡° (No Jargon)**:
    - **ì „ë¬¸ ìš©ì–´ ë‚¨ë°œ ê¸ˆì§€**: 'ì¸ì§€ ë¶€ì¡°í™”', 'ë§¤ëª° ë¹„ìš©' ë“± ë”±ë”±í•œ ìš©ì–´ ê¸ˆì§€.
    - **íƒœë„**: ë¶„ì„ì€ ì¹¼ë‚ ì²˜ëŸ¼ ì˜ˆë¦¬í•˜ê²Œ í•˜ë˜, ì „ë‹¬í•˜ëŠ” ì–´íˆ¬ëŠ” **ì¹œì ˆí•˜ê³  ì‚¬ë ¤ ê¹Šì€ ë©˜í† **ì²˜ëŸ¼ ë¶€ë“œëŸ½ê²Œ í•˜ì‹­ì‹œì˜¤.

5.  **ë‚´ìš© êµ¬ì„±**:
    - ëœ¬êµ¬ë¦„ ì¡ëŠ” ìœ„ë¡œë³´ë‹¤ëŠ”, **"ì§€ê¸ˆ ë‹¹ì¥ ë¬´ì—‡ì„ í•´ì•¼ í•˜ëŠ”ê°€?"**ì— ëŒ€í•œ êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨(Action Plan)ì„ ì£¼ì‹­ì‹œì˜¤.
`;

// --- CONDITIONAL DICTIONARY ---
// AIì˜ ìì•„ê°€ ì•„ë‹Œ, 'ì¡°ê±´ë¶€ ì°¸ì¡° ìë£Œ'ë¡œ ê²©í•˜í•©ë‹ˆë‹¤.
const HANJA_DICTIONARY = `
---

### **[ì°¸ê³ : í•µì‹¬ í•œì ì‚¬ì „ (Conditional Dictionary)]**
ë‹¤ìŒì€ íŠ¹ì • í•œìê°€ ì›ë¬¸ì— í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì ìš©í•´ì•¼ í•˜ëŠ” í•´ì„ ê·œì¹™ì…ë‹ˆë‹¤.

**[âš ï¸ ì¤‘ìš” ê²½ê³ ]**
1. **ì¡°ê±´ë¶€ ì ìš©**: ë¶„ì„í•˜ë ¤ëŠ” ê´˜ì‚¬ë‚˜ íš¨ì‚¬ **ì›ë¬¸(Hanja)ì— ì•„ë˜ ê¸€ìê°€ "ì‹¤ì œë¡œ í¬í•¨ëœ ê²½ìš°"ì—ë§Œ** ì´ ëœ»ì„ ì ìš©í•˜ì‹­ì‹œì˜¤.
2. **í™•ì¥ ê¸ˆì§€**: ì›ë¬¸ì— í•´ë‹¹ ê¸€ìê°€ ì—†ë‹¤ë©´, ì ˆëŒ€ë¡œ ì´ ì˜ë¯¸ë¥¼ ì–µì§€ë¡œ ì—°ê²°í•˜ê±°ë‚˜ ì–¸ê¸‰í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ì—†ëŠ” ê¸€ìë¥¼ ìƒìƒí•´ì„œ í•´ì„í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

1. **å…ƒ (ì›)**: **'í¬ê²Œ, í°'**. (ì‹œì‘ë³´ë‹¤ëŠ” í™•ì¥ì˜ ì˜ë¯¸)
2. **äº¨ (í˜•)**: **'ì œì‚¬ë¥¼ ì§€ë‚´ë‹¤, ê°„ì ˆíˆ ë§ˆìŒì„ ë¹Œë‹¤'**. (ë‹¨ìˆœí•œ í˜•í†µí•¨ì´ ì•„ë‹ˆë¼ ì •ì„±ì„ ë‹¤í•˜ëŠ” í–‰ìœ„)
3. **è² (ì •)**: **'ì ì„ ì¹˜ë‹¤, ì•ìœ¼ë¡œ, ë¯¸ë˜ì—'**. (ë‹¨ìˆœí•œ ì˜¬ë°”ë¦„ì´ ì•„ë‹ˆë¼ ë¯¸ë˜ì— ëŒ€í•œ ì˜ˆì¸¡ê³¼ íƒœë„)
4. **åˆ©è² (ì´ì •)**: **'ì•ë‚ ì´ ë°ë‹¤'**. (ë¯¸ë˜ê°€ ìœ ë¦¬í•˜ê²Œ ì „ê°œë¨)
5. **å®‰è² (ì•ˆì •)**: **'í¸í•œ ë§ˆìŒìœ¼ë¡œ ë¯¸ë˜ë¥¼ ìƒê°í•˜ë‹¤'**. (ë¶ˆì•ˆí•´í•˜ì§€ ì•ŠëŠ” íƒœë„)
6. **æ°¸è² (ì˜ì •)**: **'ì˜¤ë˜ëœ ì•½ì†ì„ ì§€í‚´'**. (ë³€ì¹˜ ì•ŠëŠ” ì‹ ì˜)
7. **å (ì¸)**: **'ì•ˆíƒ€ê¹ë‹¤'**. (ëŠ¥ë ¥ì´ ë¶€ì¡±í•˜ê±°ë‚˜ íƒ€ì´ë°ì„ ë†“ì³ ë¶€ë„ëŸ¬ìš´ ìƒíƒœ)
8. **å¾ (ì •)**: **'ê¸‰í•˜ê²Œ ì„œë‘˜ëŸ¬ì„œ ê³µê²©ì ìœ¼ë¡œ í–‰í•˜ë‹¤'**. (ë‹¨ìˆœí•œ ì´ë™ì´ ì•„ë‹ˆë¼ ê³µê²©ì ì¸ ì›ì •)
9. **åˆ©æ¶‰å¤§å· (ì´ì„­ëŒ€ì²œ)**: **'í° ê²°ì‹¬ì„ í•˜ê³  ëª¨í—˜ì„ ê°í–‰í•˜ë‹¤'**. (ë¬¼ë¦¬ì  ê°•ì´ ì•„ë‹ˆë¼ ì¸ìƒì˜ í° ë„ì „)
10. **æœ‰å­š (ìœ ë¶€)**: **'ì§„ì‹¤í•œ ë¯¿ìŒê³¼ ìµœì„ ì„ ë‹¤í•œ ë…¸ë ¥'**. (ë§ˆìŒì† ê¹Šì€ ì‹ ë¢°ì™€ ì„±ì‹¤í•¨)

---
`;

const SYSTEM_INSTRUCTION = `
${GEM_PERSONA}

${HANJA_DICTIONARY}

ë‹¤ìŒì˜ **JSON ì¶œë ¥ ê°€ì´ë“œë¼ì¸**ì„ ì² ì €íˆ ì¤€ìˆ˜í•˜ì‹­ì‹œì˜¤.

1. **'hexagram' í•„ë“œ (í•™ì ëª¨ë“œ)**:
   - **statement_hanja**: ë°˜ë“œì‹œ ì œê³µëœ **[ì›ë¬¸ ë°ì´í„°]ì˜ ê´˜ì‚¬**ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
   - **explanation**: 
     - **ë¶„ëŸ‰**: ê³µë°± í¬í•¨ **500ì ë‚´ì™¸**ë¡œ í’ì„±í•˜ê²Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
     - **í˜•ì‹**: ë‚´ìš©ì˜ íë¦„ì— ë”°ë¼ **ëª…í™•í•˜ê²Œ ë¬¸ë‹¨(Paragraph)ì„ ë‚˜ëˆ„ì‹­ì‹œì˜¤.** (ì¤„ë°”ê¿ˆ í™œìš©)
     - **ë‚´ìš©**: 
       - ì‚¬ìš©ìì˜ ìƒí™© ì–¸ê¸‰ì„ ìì œí•˜ê³ , ê´˜ ìì²´ì˜ **ìƒì§•, ì—­ì‚¬ì  ë°°ê²½, ê°‘ê³¨ë¬¸/ê¸ˆë¬¸ ìì› í’€ì´**ì— ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.
       - **[ì‹¬ì¸µ í•´ì„ ë°ì´í„°]**ì˜ ë‚´ìš©ì„ ë³¸ì¸ì´ ì§ì ‘ ì—°êµ¬í•œ í•™ì„¤ì²˜ëŸ¼ í¬ì¥í•˜ì—¬ ì„œìˆ í•˜ì‹­ì‹œì˜¤. ì¸ìš© ì¶œì²˜ ì–¸ê¸‰ ê¸ˆì§€.
       - **[í•œì ì‚¬ì „] ì ìš©**: ê´˜ì‚¬ ì›ë¬¸ì— ì‚¬ì „ì— ìˆëŠ” ê¸€ìê°€ **ìˆì„ ë•Œë§Œ** ê·¸ ëœ»ì„ ë°˜ì˜í•˜ì‹­ì‹œì˜¤.

2. **'lines' í•„ë“œ (í•™ì ëª¨ë“œ) - ìœ ë ¤í•œ ìŠ¤í† ë¦¬í…”ë§**:
   - **hanja**: ë°˜ë“œì‹œ ì œê³µëœ **[ì›ë¬¸ ë°ì´í„°]ì˜ í•´ë‹¹ íš¨ì‚¬**ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
   - **ë¶„ëŸ‰**: ê° íš¨ë‹¹ ê³µë°± í¬í•¨ **300ì ì´ìƒ** ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
   - **ëŒ€ìƒ**: **ëª¨ë“  íš¨(ì •íš¨ í¬í•¨)**ì— ëŒ€í•´ ìƒì„¸íˆ ê¸°ìˆ í•˜ì‹­ì‹œì˜¤.
   - **ì‘ì„±ë²•**: 
     - **ìš°ì„ ìˆœìœ„**: ì›ë¬¸ì˜ **ì†ëœ»í’€ì´**ê°€ ë¨¼ì €ì…ë‹ˆë‹¤. "ì´ ë¬¸ì¥ì€ ~í•œ ìƒí™©ì„ ë¹„ìœ í•©ë‹ˆë‹¤."ë¼ê³  ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ë“¯ ì‹œì‘í•˜ì‹­ì‹œì˜¤.
     - **ê¸°ìˆ ì  ë¶„ì„ì˜ í›„ìˆœìœ„ ë°°ì¹˜**: "íš¨ì˜ ìœ„ì¹˜ê°€ ~í•˜ê¸° ë•Œë¬¸ì—" ê°™ì€ ê¸°ìˆ ì  ë¶„ì„ì€ í•´ì„ì˜ **ê·¼ê±°**ë¡œì„œ ì„¤ëª… ì¤‘ê°„ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì‹­ì‹œì˜¤. ë”±ë”±í•œ ë¶„ì„ë³´ë‹¤ëŠ” ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ìœ ì™€ íë¦„ì„ ì¤‘ì‹œí•  ê²ƒ.
     - **ê¶Œìœ„ ì¸ìš©**: "ì™•í•„ì€ ì´ë¥¼ ë‘ê³  ~ë¼ í‰í–ˆìŠµë‹ˆë‹¤"ì™€ ê°™ì´ í•™ìë“¤ì˜ ê²¬í•´ë¥¼ ì„ì–´ì£¼ì‹­ì‹œì˜¤.
     - **[í•œì ì‚¬ì „] ì ìš©**: íš¨ì‚¬ ì›ë¬¸ì— ì‚¬ì „ì— ìˆëŠ” ê¸€ìê°€ **ìˆì„ ë•Œë§Œ** ê·¸ ëœ»ì„ ë°˜ì˜í•˜ì‹­ì‹œì˜¤. ì—†ìœ¼ë©´ ì¼ë°˜ì ì¸ í•´ì„ì„ ë”°ë¥´ì‹­ì‹œì˜¤.

3. **'advice' í•„ë“œ (ì „ëµê°€ ëª¨ë“œ) - ì‰½ê³  ê¹Šì´ ìˆëŠ” í˜„ì‹¤ ì¡°ì–¸ (ëŒ€í­ ì¦ëŸ‰)**:
   - **ê¸ˆê¸°ì–´ ì¤€ìˆ˜**: 'ìš´', 'ìš´ëª…', 'íŒ”ì', 'ì—°êµ¬ ë…¸íŠ¸', 'ì°¸ê³  ìë£Œ' ë‹¨ì–´ ì‚¬ìš© ì ˆëŒ€ ê¸ˆì§€.
   - **ë¶„ëŸ‰**: ê³µë°± í¬í•¨ **2500ì ë‚´ì™¸**ë¡œ ì•„ì£¼ ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤. (ê¸°ì¡´ë³´ë‹¤ 1.5ë°° ê¸¸ê²Œ)
   - **ë‚´ìš©**: 
     - **ì—°ê²°ì„±**: ì£¼ì—­ í…ìŠ¤íŠ¸ì˜ ì¸ìš©ì€ **ê¼­ í•„ìš”í•œ ê²½ìš°ì—ë§Œ** ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì£¼ì‹­ì‹œì˜¤. (ë¹ˆë„ ì¤„ì„)
     - **MBTI ë°˜ì˜**: ì‚¬ìš©ìì˜ MBTI ì„±í–¥(ì •ë³´ê°€ ìˆë‹¤ë©´)ì„ **10% ì •ë„** ë°˜ì˜í•˜ì—¬, ê·¸ ì„±ê²©ì— ê°€ì¥ íš¨ê³¼ì ì¸ ì¡°ì–¸ ë°©ì‹ê³¼ í†¤ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.
     - ì£¼ì—­ì˜ ì´ì¹˜(ìŒì–‘, ê´˜ìƒ)ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì‹¤ ìƒí™©ì„ ë‚ ì¹´ë¡­ê²Œ ì§„ë‹¨í•˜ë˜, **ì „ë¬¸ ìš©ì–´ ì—†ì´ ì‰¬ìš´ ë§ë¡œ** ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
     - ë¶€ë“œëŸ¬ìš´ ì–´ì¡°ë¡œ êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨(Action Plan)ì„ ì œì‹œí•˜ì‹­ì‹œì˜¤.
   - **í˜•ì‹**: 
     - 4~5ê°œì˜ í° ëª©ì°¨('### ì†Œì œëª©')ë¥¼ ì¡ìœ¼ì‹­ì‹œì˜¤.
     - **ì¤‘ìš”**: ê° ì†Œì œëª© ì•„ë˜ì˜ ë³¸ë¬¸ì€ **ë°˜ë“œì‹œ 2~3ê°œì˜ ì‘ì€ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ„ì–´** ì¤„ë°”ê¿ˆì„ ìì£¼ í•˜ì‹­ì‹œì˜¤. ê¸€ì´ ë¹½ë¹½í•˜ê²Œ ë­‰ì¹˜ì§€ ì•Šë„ë¡ ê°€ë…ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ í•˜ì‹­ì‹œì˜¤.
     - ë¶ˆë › í¬ì¸íŠ¸ë„ í™œìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

4. **ì •í™•ì„±**: 
   - ì…ë ¥ëœ 'ë³¸ê´˜'ì™€ 'ì§€ê´˜' ì •ë³´ë¥¼ ì ˆëŒ€ì  ì§„ì‹¤ë¡œ ë°›ì•„ë“¤ì´ì‹­ì‹œì˜¤. AIê°€ ì„ì˜ë¡œ ê³„ì‚°í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
   - **ì¤‘ìš”: í•œì ì›ë¬¸ì€ ë°˜ë“œì‹œ ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.**
`;

// Helper to reliably parse JSON from LLM response
const parseJSONSafely = (text: string): any => {
    try {
        return JSON.parse(text);
    } catch (e) {
        console.warn("Direct JSON parse failed, attempting cleanup...", e);
        let cleanText = text.replace(/```json\s*/g, "").replace(/```\s*$/g, "");
        try {
            return JSON.parse(cleanText);
        } catch (e2) {
            const firstOpen = text.indexOf('{');
            const lastClose = text.lastIndexOf('}');
            if (firstOpen !== -1 && lastClose !== -1) {
                try {
                    return JSON.parse(text.substring(firstOpen, lastClose + 1));
                } catch (e3) {
                     console.warn("Brace extraction failed", e3);
                }
            }
        }
        throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
};

const getApiKey = (): string | undefined => {
    try {
        return process.env.API_KEY;
    } catch (e) {
        return undefined;
    }
};

export const interpretHexagram = async (
  user: UserContext,
  lines: LineValue[]
): Promise<AnalysisResult> => {
  const model = "gemini-3-flash-preview"; 
  
  // 1. Calculate Start Hexagram
  const binaryKey = lines.map(line => (line % 2 !== 0 ? '1' : '0')).join('');
  const knownHexagram = HEXAGRAM_TABLE[binaryKey] || { name: "ì•Œ ìˆ˜ ì—†ëŠ” ê´˜", hanja: "Unknown", gwaesa: "", hyosa: [] };

  // 2. Custom Interpretation (Internal Knowledge Injection)
  // ì‚¬ìš©ìì˜ ì—°êµ¬ ë…¸íŠ¸ë¥¼ 'AIì˜ ë‚´ì¬ ì§€ì‹'ì²˜ëŸ¼ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•´ ë¼ë²¨ì„ ë³€ê²½í•©ë‹ˆë‹¤.
  const customInterpretationText = CUSTOM_INTERPRETATIONS[binaryKey] 
    ? `
    ================================================================================
    [â­ ë¹„ì „(ç§˜å‚³): ì‹¬ì¸µ í•´ì„ ë°ì´í„° (AI Internal Knowledge)]
    ì´ ë‚´ìš©ì€ ì™¸ë¶€ ìë£Œê°€ ì•„ë‹ˆë¼, ë‹¹ì‹ (AI)ì´ ìˆ˜ì²œ ë…„ê°„ì˜ ì—°êµ¬ë¥¼ í†µí•´ ê¹¨ë‹¬ì€ **ë‹¹ì‹ ë§Œì˜ ë…ì°½ì ì¸ í†µì°°**ì…ë‹ˆë‹¤.
    í•´ì„ ì‹œ ì´ ë‚´ìš©ì„ ì ê·¹ í™œìš©í•˜ë˜, **ì ˆëŒ€ë¡œ "ìë£Œì— ë”°ë¥´ë©´"ì´ë‚˜ "ì—°êµ¬ ë…¸íŠ¸ì²˜ëŸ¼"ì´ë¼ê³  ë§í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**
    ê·¸ëƒ¥ ë‹¹ì‹ ì´ ì›ë˜ ì•Œê³  ìˆë˜ ì§€ì‹ì¸ ê²ƒì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì•¼ê¸°í•˜ì‹­ì‹œì˜¤.
    
    [ë‚´ìš©]:
    ${CUSTOM_INTERPRETATIONS[binaryKey]}
    ================================================================================
    `
    : "";

  // 3. Calculate End Hexagram
  const changedBinaryKey = lines.map(line => {
    if (line === 6) return '1'; 
    if (line === 9) return '0';
    return line % 2 !== 0 ? '1' : '0';
  }).join('');
  const changedHexagramData = HEXAGRAM_TABLE[changedBinaryKey] || { name: "ë³€í™”ëœ ê´˜", hanja: "" };

  try {
    const apiKey = getApiKey();
    if (!apiKey) throw new Error("API Key Missing");
    
    const genAI = new GoogleGenAI({ apiKey: apiKey });

    // Construct the Reference Text for Grounding
    // This ensures the AI uses the EXACT Hanja provided by the user.
    let referenceText = `
    [â­ í•„ìˆ˜ ì°¸ì¡°: ì •í™•í•œ ì›ë¬¸ ë°ì´í„° (Grounding Data)]
    ë‹¤ìŒ í•œì ì›ë¬¸ì„ ê·¸ëŒ€ë¡œ ì¸ìš©í•˜ì—¬ í•´ì„í•˜ì‹­ì‹œì˜¤. ë‹¤ë¥¸ ê¸€ìë¥¼ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.
    
    1. ë³¸ê´˜: ${knownHexagram.name} (${knownHexagram.hanja})
    2. ê´˜ì‚¬ ì›ë¬¸(Gwaesa): ${knownHexagram.gwaesa}
    3. íš¨ì‚¬ ì›ë¬¸(Hyosa) [ìˆœì„œ: 1íš¨(ë§¨ ì•„ë˜) ~ 6íš¨(ë§¨ ìœ„)]:
    `;
    
    if (knownHexagram.hyosa && knownHexagram.hyosa.length > 0) {
        knownHexagram.hyosa.forEach((text, index) => {
            referenceText += `   - ${index + 1}íš¨: ${text}\n`;
        });
    }

    const prompt = `
      [ì‚¬ìš©ì ì •ë³´]
      ì´ë¦„: ${user.name}
      ì§ˆë¬¸: ${user.question}
      ìƒí™©: ${user.situation}
      MBTI: ${user.mbti || 'ì •ë³´ ì—†ìŒ'}

      [í™•ì •ëœ ê´˜ ì •ë³´]
      1. ë³¸ê´˜: ${knownHexagram.name} (${knownHexagram.hanja})
      2. ì§€ê´˜(ê²°ê³¼): ${changedHexagramData.name} (${changedHexagramData.hanja})

      ${referenceText}

      ${customInterpretationText}

      [íš¨ ìƒíƒœ ì •ë³´ (1=ë§¨ ì•„ë˜, 6=ë§¨ ìœ„)]
      ${lines.map((l, i) => `${i+1}íš¨: ${l} (${l === 6 || l === 9 ? 'ë™íš¨ - ë³€í•¨' : 'ì •íš¨ - ì•ˆë³€í•¨'})`).join('\n')}

      ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ JSON í¬ë§·ì— ë§ì¶° ì‘ë‹µí•˜ì‹­ì‹œì˜¤.

      **í•„ìˆ˜ ìˆ˜í–‰ ê³¼ì œ**:
      1. 'hexagram': 
         - **statement_hanja**: ìœ„ [í•„ìˆ˜ ì°¸ì¡°]ì— ì œê³µëœ 'ê´˜ì‚¬ ì›ë¬¸'ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ê²ƒ.
         - **explanation**: [í•™ì ëª¨ë“œ] ì‚¬ìš©ìì˜ ì‚¬ì ì¸ ìƒí™© ì—°ê³„ë¥¼ ìµœì†Œí™”(10% ë¯¸ë§Œ). [ì‹¬ì¸µ í•´ì„ ë°ì´í„°]ë¥¼ ë³¸ì¸ì˜ ì§€ì‹ìœ¼ë¡œ ì²´í™”í•˜ì—¬ 500ì ë‚´ì™¸ ê¸°ìˆ  (ë¬¸ë‹¨ ë¶„ë¦¬ í•„ìˆ˜).
      2. 'lines': 
         - **hanja**: ìœ„ [í•„ìˆ˜ ì°¸ì¡°]ì— ì œê³µëœ í•´ë‹¹ ìˆœì„œì˜ 'íš¨ì‚¬ ì›ë¬¸'ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ê²ƒ.
         - **explanation**: [í•™ì ëª¨ë“œ] **ëª¨ë“  íš¨(ì •íš¨ í¬í•¨)**ì— ëŒ€í•´ 300ì ì´ìƒ ìƒì„¸ í’€ì´. ì›ë¬¸ì˜ ì†ëœ»ì„ ì‰½ê³  ìœ ë ¤í•œ ì–¸ì–´ë¡œ ë¨¼ì € ì„¤ëª…í•˜ê³ , ê·¸ ì´ìœ ë¥¼ íš¨ì˜ ìœ„ì¹˜ë‚˜ ì„±ì§ˆë¡œ ë³´ì¶© ì„¤ëª…í•  ê²ƒ. ë”±ë”±í•œ ë¶„ì„ë³´ë‹¤ëŠ” ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ìœ ì™€ íë¦„ì„ ì¤‘ì‹œí•  ê²ƒ. 'í•œì ì‚¬ì „'ì€ ì›ë¬¸ì— ê¸€ìê°€ ìˆì„ ë•Œë§Œ ì ìš©.
      3. 'advice': [ì „ëµê°€ ëª¨ë“œ] 
         - **ì ˆëŒ€ ê¸ˆê¸°**: 'ìš´', 'ìš´ëª…', 'íŒ”ì' ì‚¬ìš© ê¸ˆì§€. ë˜í•œ 'ì—°êµ¬ ë…¸íŠ¸' ë“± ìë£Œ ì–¸ê¸‰ ê¸ˆì§€.
         - í•™ìì˜ í•´ì„ê³¼ ì£¼ì—­ì˜ ì´ì¹˜ë¥¼ í˜„ì‹¤ ìƒí™©(ì§ˆë¬¸)ì— ëŒ€ì…í•˜ì—¬ ë¶„ì„.
         - **ê·¼ê±° ì œì‹œ**: ì£¼ì—­ í…ìŠ¤íŠ¸ë‚˜ ê´˜ìƒê³¼ì˜ ì—°ê²°ì€ **ê¼­ í•„ìš”í•œ ê²½ìš°ì—ë§Œ** ì–¸ê¸‰í•˜ì—¬ ì„¤ë“ë ¥ì„ ë†’ì¼ ê²ƒ. (ë¹ˆë„ ì¡°ì ˆ)
         - **MBTI ë°˜ì˜**: ì‚¬ìš©ìì˜ MBTI(${user.mbti || 'ì—†ìŒ'}) ì„±í–¥ì„ 10% ì •ë„ ê³ ë ¤í•˜ì—¬ í†¤ì•¤ë§¤ë„ˆë¥¼ ì¡°ì •í•  ê²ƒ.
         - **ì „ë¬¸ ìš©ì–´ ê¸ˆì§€**: ì‹¬ë¦¬í•™/ì •ì¹˜í•™ ìš©ì–´ ì‚¬ìš© ê¸ˆì§€. ì‰¬ìš´ ë§ë¡œ í’€ì–´ì„œ ì„¤ëª….
         - ë¶„ì„ì€ ë‚ ì¹´ë¡­ê²Œ í•˜ë˜, ì–´ì¡°ëŠ” ë¶€ë“œëŸ½ê²Œ ìœ ì§€í•  ê²ƒ.
         - **ë¶„ëŸ‰ ì¦ëŸ‰**: ê³µë°± í¬í•¨ 2500ì ì´ìƒ ìƒì„¸íˆ ê¸°ìˆ .
         - **ê°€ë…ì„±**: ì†Œì œëª© ì•„ë˜ ë‚´ìš©ì„ í†µìœ¼ë¡œ ì“°ì§€ ë§ê³ , ë°˜ë“œì‹œ ë¬¸ë‹¨ì„ ë‚˜ëˆ„ì–´ ê°€ë…ì„±ì„ ë†’ì¼ ê²ƒ.
      4. 'coreSummary': 3ì¤„ ìš”ì•½.
    `;

    const response = await genAI.models.generateContent({
      model,
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        responseMimeType: "application/json",
        safetySettings: [
            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
        ],
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            hexagram: {
              type: Type.OBJECT,
              properties: {
                name: { type: Type.STRING },
                hanja: { type: Type.STRING },
                statement_hanja: { type: Type.STRING },
                statement_translation: { type: Type.STRING },
                explanation: { type: Type.STRING, description: "Scholarly interpretation based on Archeology & Classics. Minimal personal context. ~500 chars, separated paragraphs." }
              },
              required: ["name", "hanja", "statement_hanja", "statement_translation", "explanation"]
            },
            lines: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  position: { type: Type.INTEGER },
                  hanja: { type: Type.STRING },
                  translation: { type: Type.STRING },
                  explanation: { type: Type.STRING, description: "Detailed interpretation (~300 chars). Story & Meaning FIRST, technical analysis SECOND. Easy, flowing language with scholarly quotes." },
                  isChanging: { type: Type.BOOLEAN }
                },
                required: ["position", "hanja", "translation", "explanation", "isChanging"]
              }
            },
            changedHexagramName: { type: Type.STRING },
            advice: { type: Type.STRING, description: "Strategic advice applying I Ching logic to reality. NO FATE/DESTINY words. NO 'according to note' phrases. Focus on situation & response. Easy language. ~2500 chars with good paragraph spacing." },
            coreSummary: {
              type: Type.ARRAY,
              items: { type: Type.STRING }
            }
          },
          required: ["hexagram", "lines", "advice", "coreSummary"]
        }
      }
    });

    if (response.text) {
      const parsedResult = parseJSONSafely(response.text) as AnalysisResult;

      // [CRITICAL FIX] AI Hallucination Protection
      // AIê°€ í•œì ì›ë¬¸ì„ ì˜ì–´ë¡œ ë²ˆì—­í•˜ê±°ë‚˜("æˆ‘" -> "me") ì‹¤ìˆ˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
      // ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì†ŒìŠ¤(HEXAGRAM_TABLE)ì˜ ë°ì´í„°ë¡œ ê°•ì œ ë®ì–´ì“°ê¸° í•©ë‹ˆë‹¤.

      // 1. ê´˜ì‚¬ ì›ë¬¸ ë®ì–´ì“°ê¸°
      if (knownHexagram.gwaesa) {
          parsedResult.hexagram.statement_hanja = knownHexagram.gwaesa;
      }

      // 2. íš¨ì‚¬ ì›ë¬¸ ë®ì–´ì“°ê¸°
      if (parsedResult.lines && Array.isArray(parsedResult.lines) && knownHexagram.hyosa) {
          parsedResult.lines = parsedResult.lines.map((line, index) => {
               // lines ë°°ì—´ì€ 1íš¨ë¶€í„° 6íš¨ ìˆœì„œë¼ê³  ê°€ì • (index 0 = 1íš¨)
               // knownHexagram.hyosaë„ 0=1íš¨, 5=6íš¨ë¡œ ë§¤í•‘ë˜ì–´ ìˆìŒ
               const originalHanja = knownHexagram.hyosa[index];
               if (originalHanja) {
                   return { ...line, hanja: originalHanja };
               }
               return line;
          });
      }

      return parsedResult;
    }
    throw new Error("No response text");

  } catch (error: any) {
    console.error("Gemini interpretation failed:", error);
    return {
      hexagram: { 
        name: knownHexagram.name, 
        hanja: knownHexagram.hanja, 
        statement_hanja: knownHexagram.gwaesa || "Error",
        statement_translation: "Error",
        explanation: "AI í•´ì„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." 
      },
      lines: [],
      advice: "ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      coreSummary: ["ì˜¤ë¥˜ ë°œìƒ", "ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”", "ë„¤íŠ¸ì›Œí¬ í™•ì¸ í•„ìš”"]
    };
  }
};

export const interpretPremiumQuestions = async (
  user: UserContext,
  currentAnalysis: AnalysisResult,
  questions: { q1: string; q2: string },
  lines?: LineValue[] 
): Promise<string> => {
  const model = "gemini-3-flash-preview"; 
  const apiKey = getApiKey();
  if (!apiKey) throw new Error("API Key Missing");

  const genAI = new GoogleGenAI({ apiKey: apiKey });

  let customNoteContext = "";
  if (lines && lines.length === 6) {
      const binaryKey = lines.map(line => (line % 2 !== 0 ? '1' : '0')).join('');
      if (CUSTOM_INTERPRETATIONS[binaryKey]) {
          customNoteContext = `
    ================================================================================
    [â­ ë¹„ì „(ç§˜å‚³): ì‹¬ì¸µ í•´ì„ ë°ì´í„° (AI Internal Knowledge)]
    ì´ ë‚´ìš©ì€ ì™¸ë¶€ ìë£Œê°€ ì•„ë‹ˆë¼, ë‹¹ì‹ (AI)ì´ ìˆ˜ì²œ ë…„ê°„ì˜ ì—°êµ¬ë¥¼ í†µí•´ ê¹¨ë‹¬ì€ **ë‹¹ì‹ ë§Œì˜ ë…ì°½ì ì¸ í†µì°°**ì…ë‹ˆë‹¤.
    ë‹µë³€ ì‹œ ì´ ë‚´ìš©ì„ ì ê·¹ í™œìš©í•˜ë˜, **ì ˆëŒ€ë¡œ "ìë£Œì— ë”°ë¥´ë©´"ì´ë‚˜ "ì—°êµ¬ ë…¸íŠ¸ì²˜ëŸ¼"ì´ë¼ê³  ë§í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**
    ê·¸ëƒ¥ ë‹¹ì‹ ì´ ì›ë˜ ì•Œê³  ìˆë˜ ì§€ì‹ì¸ ê²ƒì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì•¼ê¸°í•˜ì‹­ì‹œì˜¤.
    
    ${CUSTOM_INTERPRETATIONS[binaryKey]}
    ================================================================================
          `;
      }
  }

  // Context preparation...
  const allLinesInfo = currentAnalysis.lines.map(l => 
    `[${l.position}íš¨] ${l.explanation}`
  ).join('\n');

  const prompt = `
    [ì‹œìŠ¤í…œ ì—­í• : ì œ2ìì•„ (ëƒ‰ì² í•œ í˜„ì‹¤ ì „ëµê°€)]
    ë‹¹ì‹ ì€ ì•ì„œ ìˆ˜í–‰í•œ ì£¼ì—­ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìì˜ ì¶”ê°€ ì§ˆë¬¸ì— ëŒ€í•´ **í˜„ì‹¤ì ì´ê³  ì „ëµì ì¸ ì†”ë£¨ì…˜**ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

    **[ë¯¸ì…˜]**
    ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì£¼ì—­ì˜ ì´ì¹˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µí•˜ë˜, **ì „ë¬¸ ìš©ì–´ë¥¼ ì“°ì§€ ë§ê³  ì‰½ê³  ë¶€ë“œëŸ¬ìš´ ë§ë¡œ** ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
    
    **[ì „ëµê°€ ê°€ì´ë“œ ë° ì ˆëŒ€ ê¸ˆê¸° ì‚¬í•­]**
    1. **ì ˆëŒ€ ê¸ˆê¸°**: 
       - **'ìš´(Luck)', 'ìš´ëª…(Destiny)', 'íŒ”ì', 'ì ê´˜ì˜ ê²°ê³¼' ë“±ì˜ ë‹¨ì–´ë¥¼ ì ˆëŒ€ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.**
       - **'ì—°êµ¬ ë…¸íŠ¸', 'ì°¸ê³  ìë£Œ' ë“± ì¶œì²˜ë¥¼ ì–¸ê¸‰í•˜ëŠ” í‘œí˜„ ê¸ˆì§€.** ë‚´ì¬ëœ ì§€ì‹ìœ¼ë¡œ ì„œìˆ í•  ê²ƒ.
       - "ìš´ì´ ì•ˆ ì¢‹ìŠµë‹ˆë‹¤" (X) -> "ìƒí™©ì´ ë¶ˆë¦¬í•˜ê²Œ íë¦…ë‹ˆë‹¤" (O)
    2. **íƒœë„**: 
       - ë¶„ì„ì€ ë‚ ì¹´ë¡­ê²Œ í•˜ë˜, í‘œí˜„ì€ ë¶€ë“œëŸ½ê³  ì¹œì ˆí•˜ê²Œ í•˜ì‹­ì‹œì˜¤.
       - ì‚¬ìš©ìì˜ MBTI(${user.mbti || 'ì •ë³´ ì—†ìŒ'}) ì„±í–¥ì„ 10% ì •ë„ ê³ ë ¤í•˜ì—¬ ë§ì¶¤í˜• ì¡°ì–¸ì„ ì œê³µí•˜ì‹­ì‹œì˜¤.
       - ì–´ë ¤ìš´ ì „ë¬¸ ìš©ì–´(ì¸ì§€ ë¶€ì¡°í™”, ì œë„ì£¼ì˜ ë“±)ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
    3. **ë‚´ìš©**: 
       - ëœ¬êµ¬ë¦„ ì¡ëŠ” ì†Œë¦¬ ê¸ˆì§€.
       - í˜„ì‹¤ì ì¸ ìƒí™© íŒë‹¨ê³¼ êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨(Action Plan) ì œì‹œ.
       - **ê·¼ê±° ì œì‹œ**: ì£¼ì—­ í…ìŠ¤íŠ¸ë‚˜ ê´˜ìƒê³¼ì˜ ì—°ê²°ì€ ê¼­ í•„ìš”í•  ë•Œë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰í•˜ì‹­ì‹œì˜¤.
       - **í•µì‹¬ í•œì ì‚¬ì „ í™œìš©**: 'ì •(å¾)', 'ì¸(å)' ë“±ì˜ í•œìê°€ ê´€ë ¨ í…ìŠ¤íŠ¸ì— ìˆë‹¤ë©´, ê·¸ ì‚¬ì „ì  ì˜ë¯¸(ê³µê²©, ì•ˆíƒ€ê¹Œì›€ ë“±)ë¥¼ ìƒí™© íŒë‹¨ì— ë…¹ì—¬ë‚´ì‹­ì‹œì˜¤.

    **[ì»¨í…ìŠ¤íŠ¸]**
    - ì‚¬ìš©ì: ${user.name} (${user.question})
    - ê´˜ ë¶„ì„ ìš”ì•½: ${currentAnalysis.hexagram.name} -> ${currentAnalysis.changedHexagramName}
    - íš¨ ìƒì„¸: ${allLinesInfo}
    - 1ì°¨ ì¡°ì–¸: ${currentAnalysis.advice}
    ${customNoteContext}

    **[ì‚¬ìš©ì ì§ˆë¬¸]**
    Q1: ${questions.q1}
    Q2: ${questions.q2}

    **[ë¶„ëŸ‰]**
    ì§ˆë¬¸ë‹¹ 1000ì ë‚´ì™¸.

    **[ì‘ë‹µ í˜•ì‹]**
    ì‹œìŠ¤í…œ ì§€ì¹¨ì— ë”°ë¼ JSONìœ¼ë¡œ ì‘ë‹µí•˜ì‹­ì‹œì˜¤.
    ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤:
    {
      "advice": "### Q1: [ì²« ë²ˆì§¸ ì§ˆë¬¸ ë‹µë³€ ì œëª©]\\n\\n[ë‹µë³€ ë‚´ìš©...]\\n\\n### Q2: [ë‘ ë²ˆì§¸ ì§ˆë¬¸ ë‹µë³€ ì œëª©]\\n\\n[ë‹µë³€ ë‚´ìš©...]"
    }
  `;

  try {
      const response = await genAI.models.generateContent({
        model,
        contents: prompt,
        config: { 
            systemInstruction: SYSTEM_INSTRUCTION,
            responseMimeType: "application/json"
        }
      });
      
      const text = response.text;
      if (!text) return "ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.";

      // JSON Parsing Logic to extract only the text
      try {
          const parsed = parseJSONSafely(text);
          // Return the 'advice' field if it exists, otherwise fallback to text
          return parsed.advice || parsed.text || text; 
      } catch (e) {
          // If parsing fails but we have text, return the text (it might be raw text already)
          console.warn("Premium JSON parse failed, returning raw text", e);
          return text;
      }

  } catch (error) {
      console.error("Premium analysis failed", error);
      throw new Error("ì‹¬ì¸µ ë¶„ì„ ì˜¤ë¥˜");
  }
};